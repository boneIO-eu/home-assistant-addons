# ============================================
# DEMO SENSORS PACKAGE - boneIO Energy Dashboard Demo
# ============================================
# Copy this file to /config/packages/demo_sensors.yaml
# Then add to configuration.yaml:
#   homeassistant:
#     packages:
#       demo_sensors: !include packages/demo_sensors.yaml
# ============================================

template:
  - sensor:
      # ============================================
      # MASTER STATE SENSOR - Calculates all base values
      # ============================================
      - name: "Demo BoneIO State"
        unique_id: "demo_boneio_master_state"
        state: "active"
        attributes:
          hour: "{{ now().hour }}"
          minute: "{{ now().minute }}"
          month: "{{ now().month }}"
          weekday: "{{ now().weekday() }}"
          
          seasonal: >
            {{ 0.3 + 0.7 * (0.5 + 0.5 * (((now().timetuple().tm_yday - 80) / 365 * 2 * 3.14159) | sin)) }}
          
          solar_power: >
            {% set hour = now().hour + now().minute / 60 %}
            {% set seasonal = 0.3 + 0.7 * (0.5 + 0.5 * (((now().timetuple().tm_yday - 80) / 365 * 2 * 3.14159) | sin)) %}
            {% set solar_factor = [1 - ((hour - 12.5) / 7.5) ** 2, 0] | max if 6 <= hour <= 20 else 0 %}
            {{ (6000 * seasonal * solar_factor) | round(0) }}
          
          heating_factor: >
            {% set m = now().month %}
            {% if m in [12, 1, 2] %}1.0
            {% elif m in [3, 11] %}0.6
            {% elif m in [4, 10] %}0.3
            {% else %}0.1{% endif %}
          
          cooling_factor: >
            {% set m = now().month %}
            {% set h = now().hour %}
            {% if m in [6, 7, 8] and 12 <= h <= 22 %}{{ 1 - ((h - 16) | abs) / 8 }}
            {% else %}0{% endif %}

      # ============================================
      # ENERGY SENSORS (kWh) - state_class: total for demo
      # ============================================
      
      - name: "Demo BoneIO Solar Production"
        unique_id: "demo_boneio_solar_production"
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: total
        state: >
          {% set power = state_attr('sensor.demo_boneio_state', 'solar_power') | float(0) %}
          {{ (power / 1000 * 0.0833) | round(3) }}

      - name: "Demo BoneIO Battery Energy In"
        unique_id: "demo_boneio_battery_energy_in"
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: total
        state: >
          {% set solar = state_attr('sensor.demo_boneio_state', 'solar_power') | float(0) %}
          {% set charge = [solar * 0.3, 2500] | min if solar > 2000 else 0 %}
          {{ (charge / 1000 * 0.0833) | round(3) }}

      - name: "Demo BoneIO Battery Energy Out"
        unique_id: "demo_boneio_battery_energy_out"
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: total
        state: >
          {% set h = now().hour %}
          {% set solar = state_attr('sensor.demo_boneio_state', 'solar_power') | float(0) %}
          {% set discharge = 1500 if 17 <= h <= 22 and solar < 1000 else (300 if h >= 22 or h < 6 else 0) %}
          {{ (discharge / 1000 * 0.0833) | round(3) }}

      - name: "Demo BoneIO Grid Consumption"
        unique_id: "demo_boneio_grid_consumption"
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: total
        state: >
          {% set solar = state_attr('sensor.demo_boneio_state', 'solar_power') | float(0) %}
          {% set devices = states('sensor.demo_boneio_heat_pump_power') | float(0) + states('sensor.demo_boneio_induction_power') | float(0) + states('sensor.demo_boneio_water_heater_power') | float(0) + states('sensor.demo_boneio_ac_power') | float(0) + states('sensor.demo_boneio_lighting_power') | float(0) + states('sensor.demo_boneio_washing_power') | float(0) + states('sensor.demo_boneio_ev_power') | float(0) + 150 %}
          {% set solar_used = [solar, devices] | min %}
          {% set battery = states('sensor.demo_boneio_battery_power') | float(0) %}
          {% set grid = [devices - solar_used - battery, 0] | max %}
          {{ (grid / 1000 * 0.0833) | round(3) }}

      - name: "Demo BoneIO Grid Return"
        unique_id: "demo_boneio_grid_return"
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: total
        state: >
          {% set solar = state_attr('sensor.demo_boneio_state', 'solar_power') | float(0) %}
          {% set devices = 2000 %}
          {% set excess = [solar - devices - 2000, 0] | max %}
          {{ (excess / 1000 * 0.0833) | round(3) }}

      - name: "Demo BoneIO Heat Pump Energy"
        unique_id: "demo_boneio_heat_pump_energy"
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: total
        state: >
          {% set heating = state_attr('sensor.demo_boneio_state', 'heating_factor') | float(0.5) %}
          {% set h = now().hour %}
          {% set base = 1200 * heating if 6 <= h <= 21 else 600 * heating %}
          {{ (base / 1000 * 0.0833) | round(3) }}

      - name: "Demo BoneIO Induction Energy"
        unique_id: "demo_boneio_induction_energy"
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: total
        state: >
          {% set h = now().hour %}
          {% set m = now().minute %}
          {% set cooking = 1 if (h == 7 and 20 <= m <= 50) or (h == 12 and m <= 40) or (h in [18,19] and ((h == 18 and m >= 30) or (h == 19 and m <= 30))) else 0 %}
          {{ (1500 * cooking / 1000 * 0.0833) | round(3) }}

      - name: "Demo BoneIO Water Heater Energy"
        unique_id: "demo_boneio_water_heater_energy"
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: total
        state: >
          {% set h = now().hour %}
          {% set base = 1200 if h in [6,7,8,19,20,21] else 80 %}
          {{ (base / 1000 * 0.0833) | round(3) }}

      - name: "Demo BoneIO AC Energy"
        unique_id: "demo_boneio_ac_energy"
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: total
        state: >
          {% set cooling = state_attr('sensor.demo_boneio_state', 'cooling_factor') | float(0) %}
          {{ (1500 * cooling / 1000 * 0.0833) | round(3) }}

      - name: "Demo BoneIO Lighting Energy"
        unique_id: "demo_boneio_lighting_energy"
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: total
        state: >
          {% set h = now().hour %}
          {% set base = 200 if 18 <= h <= 23 else (120 if 6 <= h <= 8 else 30) %}
          {{ (base / 1000 * 0.0833) | round(3) }}

      - name: "Demo BoneIO Washing Energy"
        unique_id: "demo_boneio_washing_energy"
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: total
        state: >
          {% set h = now().hour %}
          {% set wd = now().weekday() %}
          {% set running = 1 if (wd >= 5 and h in [10,11,14,15]) or (wd < 5 and h == 19) else 0 %}
          {{ (800 * running / 1000 * 0.0833) | round(3) }}

      - name: "Demo BoneIO EV Energy"
        unique_id: "demo_boneio_ev_energy"
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: total
        state: >
          {% set h = now().hour %}
          {% set charging = 1 if h in [23, 0, 1, 2, 3, 4] else 0 %}
          {{ (3500 * charging / 1000 * 0.0833) | round(3) }}

      # ============================================
      # POWER SENSORS (W)
      # ============================================
      
      - name: "Demo BoneIO Solar Power"
        unique_id: "demo_boneio_solar_power"
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: "{{ state_attr('sensor.demo_boneio_state', 'solar_power') | float(0) | int }}"

      - name: "Demo BoneIO Battery Power"
        unique_id: "demo_boneio_battery_power"
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >
          {# Only show discharge (positive) for power sources graph #}
          {% set h = now().hour %}
          {% set solar = state_attr('sensor.demo_boneio_state', 'solar_power') | float(0) %}
          {% set devices = 2000 %}
          {% set solar_deficit = [devices - solar, 0] | max %}
          {% if solar > devices + 500 %}
            {{ 0 }}
          {% elif solar_deficit > 500 and 17 <= h <= 22 %}
            {{ ([1500, solar_deficit * 0.6] | min) | int }}
          {% elif solar_deficit > 0 and (h >= 22 or h < 6) %}
            {{ ([300, solar_deficit * 0.3] | min) | int }}
          {% else %}
            {{ 0 }}
          {% endif %}

      - name: "Demo BoneIO Grid Power"
        unique_id: "demo_boneio_grid_power"
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >
          {% set solar = state_attr('sensor.demo_boneio_state', 'solar_power') | float(0) %}
          {% set devices = states('sensor.demo_boneio_heat_pump_power') | float(0) + states('sensor.demo_boneio_induction_power') | float(0) + states('sensor.demo_boneio_water_heater_power') | float(0) + states('sensor.demo_boneio_ac_power') | float(0) + states('sensor.demo_boneio_lighting_power') | float(0) + states('sensor.demo_boneio_washing_power') | float(0) + states('sensor.demo_boneio_ev_power') | float(0) + 150 %}
          {% set solar_used = [solar, devices] | min %}
          {% set battery = states('sensor.demo_boneio_battery_power') | float(0) %}
          {{ ([devices - solar_used - battery, 0] | max) | int }}

      - name: "Demo BoneIO Heat Pump Power"
        unique_id: "demo_boneio_heat_pump_power"
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >
          {% set heating = state_attr('sensor.demo_boneio_state', 'heating_factor') | float(0.5) %}
          {% set h = now().hour %}
          {{ (1200 * heating if 6 <= h <= 21 else 600 * heating) | int }}

      - name: "Demo BoneIO Induction Power"
        unique_id: "demo_boneio_induction_power"
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >
          {% set h = now().hour %}
          {% set m = now().minute %}
          {% if h == 7 and 20 <= m <= 50 %}1200
          {% elif h == 12 and m <= 40 %}1500
          {% elif h in [18,19] and ((h == 18 and m >= 30) or (h == 19 and m <= 30)) %}2000
          {% else %}0{% endif %}

      - name: "Demo BoneIO Water Heater Power"
        unique_id: "demo_boneio_water_heater_power"
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >
          {% set h = now().hour %}
          {{ 1200 if h in [6,7,8,19,20,21] else 80 }}

      - name: "Demo BoneIO AC Power"
        unique_id: "demo_boneio_ac_power"
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >
          {% set cooling = state_attr('sensor.demo_boneio_state', 'cooling_factor') | float(0) %}
          {{ (1500 * cooling) | int }}

      - name: "Demo BoneIO Lighting Power"
        unique_id: "demo_boneio_lighting_power"
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >
          {% set h = now().hour %}
          {{ 200 if 18 <= h <= 23 else (120 if 6 <= h <= 8 else 30) }}

      - name: "Demo BoneIO Washing Power"
        unique_id: "demo_boneio_washing_power"
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >
          {% set h = now().hour %}
          {% set wd = now().weekday() %}
          {% if (wd >= 5 and h in [10,11,14,15]) or (wd < 5 and h == 19) %}800{% else %}0{% endif %}

      - name: "Demo BoneIO EV Power"
        unique_id: "demo_boneio_ev_power"
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >
          {% set h = now().hour %}
          {{ 3500 if h in [23, 0, 1, 2, 3, 4] else 0 }}

      # ============================================
      # WATER SENSORS (L)
      # ============================================
      
      - name: "Demo BoneIO Water Total"
        unique_id: "demo_boneio_water_total"
        unit_of_measurement: "L"
        device_class: water
        state_class: total
        state: >
          {% set h = now().hour %}
          {% set base = 20 if 7 <= h <= 9 else (15 if 18 <= h <= 21 else 3) %}
          {{ (base * 0.0833) | round(2) }}

      - name: "Demo BoneIO Water House"
        unique_id: "demo_boneio_water_house"
        unit_of_measurement: "L"
        device_class: water
        state_class: total
        state: >
          {% set h = now().hour %}
          {% set base = 18 if 7 <= h <= 9 else (13 if 18 <= h <= 21 else 2.5) %}
          {{ (base * 0.0833) | round(2) }}

      - name: "Demo BoneIO Water Garden"
        unique_id: "demo_boneio_water_garden"
        unit_of_measurement: "L"
        device_class: water
        state_class: total
        state: >
          {% set h = now().hour %}
          {% set m = now().month %}
          {% set summer = 1 if m in [5,6,7,8,9] else 0 %}
          {% set watering = 1 if h in [6,7,19,20] else 0 %}
          {{ (25 * summer * watering * 0.0833) | round(2) }}
